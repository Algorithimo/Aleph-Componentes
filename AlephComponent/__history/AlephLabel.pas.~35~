unit AlephLabel;

interface

uses
  System.SysUtils,
  System.Classes,
  FMX.Types,
  FMX.Controls,
  FMX.Controls.Presentation,
  FMX.StdCtrls,
  FMX.Objects,
  System.Generics.Collections,
  AlephRem,
  AlephTipos,
  AlephREmFont,
  GlobalFontSizeManager;

type
  TAlephLabel = class(TLabel, IRemFontSize)
  private
    FRemMargins: TREmMargins;
    FRemFontSize: TREmFontSize;
    FGlobalFontSizeManager: TGlobalFontSizeManager;
    function GetRemMargins: TREmMargins;
    procedure SetRemMargins(const Value: TREmMargins);
    function GetTextRem: TREmFontSize;
    procedure SetTextRem(const Value: TREmFontSize);
    procedure RegisterWithGlobalFontManager;
    procedure SyncWithGlobalFontSize;
  protected
    procedure ResizeFont(Sender: TObject);
    procedure Loaded; override;
  public
    constructor Create(AOwner: TComponent); override;
    destructor Destroy; override;
  published
    property MarginsREm: TREmMargins read GetRemMargins write SetRemMargins;
    property TextRem: TREmFontSize  read GetTextRem write SetTextRem;
  end;

procedure Register;

implementation

procedure Register;
begin
  RegisterComponents('Aleph', [TAlephLabel]);
end;

{ TAlephLabel }

constructor TAlephLabel.Create(AOwner: TComponent);
begin
   inherited Create(AOwner);
  FREmMargins := TREmMargins.Create(Self);
  FRemFontSize := TREmFontSize.Create(12);
  FGlobalFontSizeManager := TGlobalFontSizeManager.Create(Self);
  RegisterWithGlobalFontManager;
end;

destructor TAlephLabel.Destroy;
begin
  FreeAndNil(FREmMargins);
  FreeAndNil(FRemFontSize);
  FGlobalFontSizeManager.UnregisterControl(Self);
  FGlobalFontSizeManager.Free;
  inherited;
end;

function TAlephLabel.GetRemMargins: TREmMargins;
begin
  Result := FRemMargins;
end;

function TAlephLabel.GetTextRem: TREmFontSize;
begin
  Result := FRemFontSize;
end;

procedure TAlephLabel.Loaded;
begin
  inherited Loaded;
  if Assigned(FGlobalFontSizeManager) then
    FGlobalFontSizeManager.RegisterControl(Self);
end;

procedure TAlephLabel.RegisterWithGlobalFontManager;
begin
  if Assigned(FGlobalFontSizeManager) then
    FGlobalFontSizeManager.RegisterControl(Self);
end;

procedure TAlephLabel.ResizeFont(Sender: TObject);
begin
 if Assigned(FGlobalFontSizeManager) then
  begin
    FGlobalFontSizeManager.UpdateFontForControl(Self);
    self.TextSettings.Font.Size := FGlobalFontSizeManager.CalculateFontSize(Self);
  end;
end;


procedure TAlephLabel.SetRemMargins(const Value: TREmMargins);
begin
  if Assigned(FRemMargins) then
    FRemMargins.Assign(Value);
end;

procedure TAlephLabel.SetTextRem(const Value: TREmFontSize);
begin
  if Assigned(FRemFontSize) then
  begin
    FRemFontSize.Assign(Value);
    SyncWithGlobalFontSize;
  end;
end;

procedure TAlephLabel.SyncWithGlobalFontSize;
begin
  if Assigned(FGlobalFontSizeManager) and Assigned(FRemFontSize) then
  begin
    FRemFontSize.FontSize := FGlobalFontSizeManager.FontBase;
    ResizeFont(nil);
  end;
end;

end.
